



<!DOCTYPE html>
<html lang="en">
<head>

    <style>
       body {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
}

.container {
    display: flex;
    flex-direction: column;
    text-align: left;
    width: 60%;
    box-sizing: border-box;
}

.channel-status {
    font-size: 18px;
    margin-top: 20px;
}

canvas {
    width: 100%;
    height: auto;
}

.list-container {
    max-height: 150px;
    overflow-y: auto;
    margin-top: 10px;
}

.pie-chart-container {
    width: 15%;
    padding: 2px;
    box-sizing: border-box;
}

.online{
    color: blue;
}
.offline {
    color: red;
}

    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">
    <h1>ThingSpeak Channel Status</h1>
    <div class="list-container" id="status-list-container"></div>
    <div id="status-count" class="channel-status"></div>
</div>

<div class="pie-chart-container">
    <canvas id="pie-chart"></canvas>
</div>

<script>
    const channels = [
        { name: 'Mobile Airqo 1', id: 2346960 },
        { name: 'Mobile Airqo 2', id: 2346964 },
        { name: 'Mobile Airqo 3', id: 2346967 },
        { name: 'Mobile Airqo 4', id: 2346969 },
        { name: 'Mobile Airqo 5', id: 2346963 },
        { name: 'Mobile Airqo 6', id: 2346968 },
        { name: 'Mobile Airqo 7', id: 2346974 },
        { name: 'Mobile Airqo 8', id: 2346988 },
        { name: 'Mobile Airqo 09', id: 2346962 },
        { name: 'Mobile Airqo 10', id: 2346978 },
        { name: 'Mobile Airqo 11', id: 2346993 },
        { name: 'Mobile Airqo 12', id: 2346999 },
        { name: 'Mobile Airqo 13', id: 2346986 },
        { name: 'Mobile Airqo 14', id: 2347051 },
        { name: 'Mobile Airqo 15', id: 2347059 }
    ];
    let onlineCount = 0;
    let offlineCount = 0;
    const onlineChannels = [];
    const offlineChannels = [];

    async function checkChannelStatus(channel) {
        try {
            const response = await fetch(`https://api.thingspeak.com/channels/${channel.id}/feeds.json?results=1`);
            const data = await response.json();

            if (data.feeds.length > 0) {
                const lastEntryTime = new Date(data.feeds[0].created_at);
                const currentTime = new Date();
                const timeDifference = currentTime - lastEntryTime;

                const isOnline = timeDifference < (10 * 60 * 1000);

                let lastSeenText = '';
                if (isOnline) {
                    lastSeenText = 'Online';
                } else {
                    lastSeenText = getLastSeenText(timeDifference);
                }

                onlineCount += isOnline ? 1 : 0;
                offlineCount += isOnline ? 0 : 1;

                onlineChannels.push({ channelName: channel.name, status: lastSeenText });
                return { status: lastSeenText, channelName: channel.name, lastSeen: lastSeenText };
            }
        } catch (error) {
            console.error('Error fetching data:', error);
        }

        offlineCount++;
        offlineChannels.push({ channelName: channel.name, status: 'Error' });
        return { status: 'Error', channelName: channel.name, lastSeen: 'Error' };
    }

    function getLastSeenText(timeDifference) {
        const minutes = Math.floor(timeDifference / (60 * 1000));
        const hours = Math.floor(timeDifference / (60 * 60 * 1000));
        const days = Math.floor(timeDifference / (24 * 60 * 60 * 1000));
        const weeks = Math.floor(timeDifference / (7 * 24 * 60 * 60 * 1000));
        const months = Math.floor(timeDifference / (30 * 24 * 60 * 60 * 1000));

        if (minutes < 60) {
            return `${minutes} minutes ago`;
        } else if (hours < 24) {
            return `${hours} hours ago`;
        } else if (days < 7) {
            return `${days} days ago`;
        } else if (weeks < 4) {
            return `${weeks} weeks ago`;
        } else {
            return `${months} months ago`;
        }
    }
    async function updateStatusContainer() {
    const statusListContainer = document.getElementById('status-list-container');
    const statusCount = document.getElementById('status-count');
    const pieChartCanvas = document.getElementById('pie-chart');

    onlineCount = 0;
    offlineCount = 0;
    onlineChannels.length = 0;
    offlineChannels.length = 0;

    const statusPromises = channels.map(checkChannelStatus);
    const statuses = await Promise.all(statusPromises);

    statusListContainer.innerHTML = statuses.map(status => {
    const statusClass = status.status.toLowerCase();
    return `<div class="${statusClass}">${status.channelName}: <span class="${statusClass}">${status.status}</span> (${status.lastSeen})</div>`;
}).join('');


    statusCount.innerHTML = `Online: ${onlineCount} | Offline: ${offlineCount}`;

    updatePieChart(pieChartCanvas);
}
    function updatePieChart(canvas) {
        const ctx = canvas.getContext('2d');
        const data = {
            labels: ['Online', 'Offline'],
            datasets: [{
                data: [onlineCount, offlineCount],
                backgroundColor: ['#36A2EB', '#FF6384'],
                hoverBackgroundColor: ['#36A2EB', '#FF6384']
            }]
        };

        const options = {
            responsive: false,
            maintainAspectRatio: false
        };

        if (window.myPieChart) {
            window.myPieChart.destroy();
        }

        window.myPieChart = new Chart(ctx, {
            type: 'pie',
            data: data,
            options: options
        });
    }

    updateStatusContainer();
    setInterval(updateStatusContainer, 1 * 60 * 1000);
</script>

</body>
</html>
